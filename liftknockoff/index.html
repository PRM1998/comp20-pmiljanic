<!DOCTYPE html>

<html>

<head>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk&callback=createMap"
    async defer></script>
	<title>Comp20 - Assignment 2</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="style.css" type="text/css" />

	<script>
		var myLat = 0;
		var myLng = 0;
		var me;
		var mySettings;
		var carMarker;
		var weinerMarker;
		//var passengerMarker;
		var meMarker;
		var map;
		var infoWindow;

		function createMap(){			
			me = new google.maps.LatLng(myLat, myLng);
			infoWindow = new google.maps.InfoWindow();
			mySettings = {
				zoom: 8, 
				center: me,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			
			map = new google.maps.Map(document.getElementById('map'), mySettings);
			getMyLocation();
		}

		function getMyLocation(){
			if(navigator.geolocation){
				navigator.geolocation.getCurrentPosition(function(myPos){
					myLat = myPos.coords.latitude;
					myLng = myPos.coords.longitude;
					makeMap();
				});
			}
			else{
				console.log("Error getting locale");
			}
		}

		function makeMap(){
			me = new google.maps.LatLng(myLat, myLng);
			map.panTo(me);
			meMarker = new google.maps.Marker({
				position: me,
				title: "Here You Are!",
				icon: "me.png"
			});
			meMarker.setMap(map);
			google.maps.event.addListener(meMarker, 'click', function() {
				infoWindow.setContent(meMarker.title);
				infoWindow.open(map, meMarker);
			});

			loadData();
		}

		function loadData(){
			request = new XMLHttpRequest();
			request.open('POST', "https://hans-moleman.herokuapp.com/rides", true);
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			var sent = "username=kx8MrRpU&lat=" + myLat + "&lng=" + myLng;
			request.send(sent);

			request.onreadystatechange = function(){
				if (request.readyState == 4 && request.status == 200) {
					data = JSON.parse(request.responseText);
					console.log(data);
					var dataArr;
					if(data.hasOwnProperty("passengers")){
						dataArr = data.passengers;
						for(i = 0; i < dataArr.length; i++){
							var passengerMarker = new google.maps.Marker({
								position: google.maps.LatLng(dataArr[i].lat, dataArr[i].lng),
								title: dataArr[i].username,
								icon: "passenger.png",
							});
							console.log(passengerMarker);
							console.log(i);
							passengerMarker.setMap(map);
							google.maps.event.addListener(passengerMarker, 'click', function() {
								infoWindow.setContent(passengerMarker.title);
								infoWindow.open(map, passengerMarker);
							});
						}
					}
					else if(data.hasOwnProperty("vehicles")){
						dataArr = data.vehicles;
						for(i = 0; i < dataArr.length; i++){

						}
						console.log("yoooooooo");
					}
					console.log(dataArr);
					/*var ids = "";
					for(i = 0; i < dataArr.length; i++) {
						ids += dataArr[i]._id
					}
					console.log(ids);*/

				}
			};

			//request.send();
		}


		console.log(10);
	</script>
</head>

<body onload = "createMap()">

	<div id = "map"></div>

</body>
</html>

